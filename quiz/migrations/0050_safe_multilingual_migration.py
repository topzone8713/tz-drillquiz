# Generated by Django 4.2.7 on 2025-08-18
# 
# ğŸš€ ìš´ì˜ í™˜ê²½ ì•ˆì „ ë§ˆì´ê·¸ë ˆì´ì…˜
# 
# âš ï¸  ì¤‘ìš”: ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ìš´ì˜ í™˜ê²½(devops ë„¤ì„ìŠ¤í˜ì´ìŠ¤)ì—ì„œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤!
# 
# ğŸ”’ ì•ˆì „ì„± ë³´ì¥:
# - ê¸°ì¡´ ë°ì´í„° ì†ì‹¤ ë°©ì§€
# - ë‹¨ê³„ë³„ ê²€ì¦ í¬í•¨
# - ë¡¤ë°± ê°€ëŠ¥í•œ êµ¬ì¡°
# - ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
#
# ğŸ“‹ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­:
# 1. ë°˜ë“œì‹œ ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìˆ˜í–‰: pg_dump -U admin -d drillquiz > backup_$(date +%Y%m%d_%H%M%S).sql
# 2. ìš´ì˜ ì‹œê°„ëŒ€ê°€ ì•„ë‹Œ ì‹œê°„ì— ì ìš©
# 3. ë¡¤ë°± ê³„íš ìˆ˜ë¦½ ë° ì¤€ë¹„
# 4. ìŠ¤í…Œì´ì§• í™˜ê²½ì—ì„œ ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
#
# ğŸ¯ ë§ˆì´ê·¸ë ˆì´ì…˜ ëª©í‘œ:
# - Study, Exam, Question ëª¨ë¸ì— ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
# - ê¸°ì¡´ ë°ì´í„°ë¥¼ ë‹¤êµ­ì–´ í•„ë“œë¡œ ì•ˆì „í•˜ê²Œ ë³µì‚¬
# - ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
# - ê¸°ì¡´ í•„ë“œ ì œê±° (ë°ì´í„° ë³µì‚¬ ì™„ë£Œ í›„)
#
# ğŸ“ ì°¸ê³ : DATABASE_RECOVERY_LOG.md íŒŒì¼ì— ìƒì„¸í•œ ë¬¸ì œ í•´ê²° ê³¼ì •ì´ ê¸°ë¡ë¨

from django.db import migrations, models
import logging

logger = logging.getLogger(__name__)

def check_and_set_created_language_defaults(apps, schema_editor):
    """
    ì•ˆì „í•œ created_language í•„ë“œ ê¸°ë³¸ê°’ ì„¤ì •

    âš ï¸ ì¤‘ìš”: created_language í•„ë“œëŠ” ì´ë¯¸ ëª¨ë¸ê³¼ DBì— ì¡´ì¬í•¨
    ì´ í•¨ìˆ˜ëŠ” ê¸°ì¡´ ë ˆì½”ë“œì˜ ê¸°ë³¸ê°’ë§Œ ì„¤ì •í•¨ (ADD COLUMNì€ í•˜ì§€ ì•ŠìŒ)
    """
    from django.db import connection

    # ëª¨ë“  DBì—ì„œ ë™ì¼í•˜ê²Œ ì‘ë™
    logger.info("Setting created_language default values")

    with connection.cursor() as cursor:
        try:
            # Study í…Œì´ë¸”ì˜ NULL ê°’ì„ 'ko'ë¡œ ì—…ë°ì´íŠ¸
            cursor.execute("""
                UPDATE quiz_study
                SET created_language = 'ko'
                WHERE created_language IS NULL
            """)
            logger.info(f"Study: Updated {cursor.rowcount} records")
        except Exception as e:
            logger.warning(f"Error updating Study created_language: {str(e)}")

        try:
            # Exam í…Œì´ë¸”ì˜ NULL ê°’ì„ 'ko'ë¡œ ì—…ë°ì´íŠ¸
            cursor.execute("""
                UPDATE quiz_exam
                SET created_language = 'ko'
                WHERE created_language IS NULL
            """)
            logger.info(f"Exam: Updated {cursor.rowcount} records")
        except Exception as e:
            logger.warning(f"Error updating Exam created_language: {str(e)}")

        try:
            # Question í…Œì´ë¸”ì˜ NULL ê°’ì„ 'ko'ë¡œ ì—…ë°ì´íŠ¸
            cursor.execute("""
                UPDATE quiz_question
                SET created_language = 'ko'
                WHERE created_language IS NULL
            """)
            logger.info(f"Question: Updated {cursor.rowcount} records")
        except Exception as e:
            logger.warning(f"Error updating Question created_language: {str(e)}")

def reverse_created_language_defaults(apps, schema_editor):
    """Reverse operation - no-op for safety"""
    pass

def safe_migrate_study_data(apps, schema_editor):
    """
    Study ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜

    ì•ˆì „ì„± ë³´ì¥:
    1. ê¸°ì¡´ ë°ì´í„° ë°±ì—… (ë¡œê¹…)
    2. ë‹¨ê³„ë³„ ë°ì´í„° ë³µì‚¬
    3. ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
    4. ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒì„¸ ë¡œê¹…
    """
    Study = apps.get_model('quiz', 'Study')
    
    from django.db import connection
    
    try:
        # 1ë‹¨ê³„: ê¸°ì¡´ ë°ì´í„° ë°±ì—… ë° ë¡œê¹…
        with connection.cursor() as cursor:
            cursor.execute("""
                SELECT id, title, goal 
                FROM quiz_study 
                WHERE title IS NOT NULL OR goal IS NOT NULL
            """)
            existing_data = cursor.fetchall()
            
            logger.info(f"Study ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: {len(existing_data)}ê°œ ë ˆì½”ë“œ ì²˜ë¦¬ ì˜ˆì •")
            
            for row in existing_data:
                study_id, title, goal = row
                study = Study.objects.get(id=study_id)
                
                # 2ë‹¨ê³„: ë°ì´í„° ë³µì‚¬ (ì•ˆì „í•˜ê²Œ)
                if title:
                    study.title_ko = title
                    study.title_en = title  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                    study.is_ko_complete = True
                    study.is_en_complete = False
                    logger.info(f"Study {study_id}: title '{title}' â†’ title_ko, title_en ë³µì‚¬ ì™„ë£Œ")
                
                if goal:
                    study.goal_ko = goal
                    study.goal_en = ""  # ì˜ì–´ ëª©í‘œëŠ” ë¹ˆ ê°’ìœ¼ë¡œ ìœ ì§€
                    study.is_ko_complete = study.is_ko_complete and True
                    study.is_en_complete = study.is_en_complete and False
                    logger.info(f"Study {study_id}: goal '{goal}' â†’ goal_ko ë³µì‚¬ ì™„ë£Œ")
                
                study.created_language = 'ko'
                study.save()
        
        # 3ë‹¨ê³„: ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
        verification_count = Study.objects.filter(title_ko__isnull=False).count()
        logger.info(f"Study ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: {verification_count}ê°œ ë ˆì½”ë“œ ê²€ì¦ë¨")
        
        # í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í—ˆìš©
        if verification_count == 0 and len(existing_data) == 0:
            logger.info("í…ŒìŠ¤íŠ¸ í™˜ê²½: ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ì–´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
        elif verification_count == 0:
            raise ValueError("Study ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: title_koê°€ ì„¤ì •ëœ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤!")
            
    except Exception as e:
        logger.error(f"Study ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        raise

def safe_migrate_exam_data(apps, schema_editor):
    """Exam ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜"""
    Exam = apps.get_model('quiz', 'Exam')

    from django.db import connection

    try:
        # 1ë‹¨ê³„: ê¸°ì¡´ ë°ì´í„° ë°±ì—… ë° ë¡œê¹…
        with connection.cursor() as cursor:
            cursor.execute("""
                SELECT id, title, description 
                FROM quiz_exam 
                WHERE title IS NOT NULL OR description IS NOT NULL
            """)
            existing_data = cursor.fetchall()
            
            logger.info(f"Exam ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: {len(existing_data)}ê°œ ë ˆì½”ë“œ ì²˜ë¦¬ ì˜ˆì •")
            
            for row in existing_data:
                exam_id, title, description = row
                exam = Exam.objects.get(id=exam_id)
                
                # 2ë‹¨ê³„: ë°ì´í„° ë³µì‚¬ (ì•ˆì „í•˜ê²Œ)
                if title:
                    exam.title_ko = title
                    exam.title_en = title  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                    exam.is_ko_complete = True
                    exam.is_en_complete = False
                    logger.info(f"Exam {exam_id}: title '{title}' â†’ title_ko, title_en ë³µì‚¬ ì™„ë£Œ")
                
                if description:
                    exam.description_ko = description
                    exam.description_en = description  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                    exam.is_ko_complete = exam.is_ko_complete and True
                    exam.is_en_complete = exam.is_en_complete and False
                    logger.info(f"Exam {exam_id}: description ë³µì‚¬ ì™„ë£Œ")
                
                exam.created_language = 'ko'
                exam.save()
        
        # 3ë‹¨ê³„: ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
        verification_count = Exam.objects.filter(title_ko__isnull=False).count()
        logger.info(f"Exam ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: {verification_count}ê°œ ë ˆì½”ë“œ ê²€ì¦ë¨")
        
        # í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í—ˆìš©
        if verification_count == 0 and len(existing_data) == 0:
            logger.info("í…ŒìŠ¤íŠ¸ í™˜ê²½: ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ì–´ Exam ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
        elif verification_count == 0:
            raise ValueError("Exam ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: title_koê°€ ì„¤ì •ëœ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤!")
            
    except Exception as e:
        logger.error(f"Exam ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        raise

def safe_migrate_question_data(apps, schema_editor):
    """Question ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜"""
    Question = apps.get_model('quiz', 'Question')

    from django.db import connection

    try:
        # 1ë‹¨ê³„: ê¸°ì¡´ ë°ì´í„° ë°±ì—… ë° ë¡œê¹…
        with connection.cursor() as cursor:
            cursor.execute("""
                SELECT id, title, content, answer, explanation 
                FROM quiz_question 
                WHERE title IS NOT NULL OR content IS NOT NULL OR answer IS NOT NULL OR explanation IS NOT NULL
            """)
            existing_data = cursor.fetchall()
            
            logger.info(f"Question ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: {len(existing_data)}ê°œ ë ˆì½”ë“œ ì²˜ë¦¬ ì˜ˆì •")
            
            for row in existing_data:
                question_id, title, content, answer, explanation = row
                question = Question.objects.get(id=question_id)
                
                # 2ë‹¨ê³„: ë°ì´í„° ë³µì‚¬ (ì•ˆì „í•˜ê²Œ)
                if title:
                    question.title_ko = title
                    question.title_en = title  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                    question.is_ko_complete = True
                    question.is_en_complete = False
                
                if content:
                    question.content_ko = content
                    question.content_en = content  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                    question.is_ko_complete = question.is_ko_complete and True
                    question.is_en_complete = question.is_en_complete and False
                
                if answer:
                    question.answer_ko = answer
                    question.answer_en = answer  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                    question.is_ko_complete = question.is_ko_complete and True
                    question.is_en_complete = question.is_en_complete and False
                
                if explanation:
                    question.explanation_ko = explanation
                    question.explanation_en = explanation  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                    question.is_ko_complete = question.is_ko_complete and True
                    question.is_en_complete = question.is_en_complete and False
                
                question.created_language = 'ko'
                question.save()
                
                if question_id % 100 == 0:  # 100ê°œë§ˆë‹¤ ì§„í–‰ìƒí™© ë¡œê¹…
                    logger.info(f"Question ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ ì¤‘: {question_id}ê°œ ì²˜ë¦¬ë¨")
        
        # 3ë‹¨ê³„: ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
        verification_count = Question.objects.filter(title_ko__isnull=False).count()
        logger.info(f"Question ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: {verification_count}ê°œ ë ˆì½”ë“œ ê²€ì¦ë¨")
        
        # í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í—ˆìš©
        if verification_count == 0 and len(existing_data) == 0:
            logger.info("í…ŒìŠ¤íŠ¸ í™˜ê²½: ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ì–´ Question ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
        elif verification_count == 0:
            raise ValueError("Question ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: title_koê°€ ì„¤ì •ëœ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤!")
            
    except Exception as e:
        logger.error(f"Question ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        raise

def verify_migration_success(apps, schema_editor):
    """ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ ì—¬ë¶€ë¥¼ ê²€ì¦"""
    Study = apps.get_model('quiz', 'Study')
    Exam = apps.get_model('quiz', 'Exam')
    Question = apps.get_model('quiz', 'Question')
    
    # Study ê²€ì¦
    study_count = Study.objects.filter(title_ko__isnull=False).count()
    total_study = Study.objects.count()
    if study_count == 0 and total_study > 0:
        raise ValueError(f"Study ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì‹¤íŒ¨: {total_study}ê°œ ì¤‘ {study_count}ê°œë§Œ title_ko ì„¤ì •ë¨")
    
    # Exam ê²€ì¦
    exam_count = Exam.objects.filter(title_ko__isnull=False).count()
    total_exam = Exam.objects.count()
    if exam_count == 0 and total_exam > 0:
        raise ValueError(f"Exam ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì‹¤íŒ¨: {total_exam}ê°œ ì¤‘ {exam_count}ê°œë§Œ title_ko ì„¤ì •ë¨")
    
    # Question ê²€ì¦
    question_count = Question.objects.filter(title_ko__isnull=False).count()
    total_question = Question.objects.count()
    if question_count == 0 and total_question > 0:
        raise ValueError(f"Question ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì‹¤íŒ¨: {total_question}ê°œ ì¤‘ {question_count}ê°œë§Œ title_ko ì„¤ì •ë¨")
    
    logger.info(f"ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì™„ë£Œ: Study {study_count}/{total_study}, Exam {exam_count}/{total_exam}, Question {question_count}/{total_question}")

def reverse_migrate(apps, schema_editor):
    """
    ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ëŒë¦¬ê¸° (í•„ìš”ì‹œ)
    """
    logger.warning("ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ëŒë¦¬ê¸° ì‹œì‘ - ì£¼ì˜: ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥ì„± ìˆìŒ")
    
    Study = apps.get_model('quiz', 'Study')
    Exam = apps.get_model('quiz', 'Exam')
    Question = apps.get_model('quiz', 'Question')
    
    # Study ë˜ëŒë¦¬ê¸°
    for study in Study.objects.all():
        if study.title_ko:
            study.title = study.title_ko
        if study.goal_ko:
            study.goal = study.goal_ko
        study.save()
    
    # Exam ë˜ëŒë¦¬ê¸°
    for exam in Exam.objects.all():
        if exam.title_ko:
            exam.title = exam.title_ko
        if exam.description_ko:
            exam.description = exam.description_ko
        exam.save()
    
    # Question ë˜ëŒë¦¬ê¸°
    for question in Question.objects.all():
        if question.title_ko:
            question.title = question.title_ko
        if question.content_ko:
            question.content = question.content_ko
        if question.answer_ko:
            question.answer = question.answer_ko
        if question.explanation_ko:
            question.explanation = question.explanation_ko
        question.save()
    
    logger.info("ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ëŒë¦¬ê¸° ì™„ë£Œ")

class Migration(migrations.Migration):
    """
    ì•ˆì „í•œ ë‹¤êµ­ì–´ ë§ˆì´ê·¸ë ˆì´ì…˜

    ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ìš´ì˜ í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
    ê° ë‹¨ê³„ë§ˆë‹¤ ë°ì´í„° ë¬´ê²°ì„±ì„ ê²€ì¦í•˜ê³ , ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒì„¸í•œ ë¡œê¹…ì„ ì œê³µí•©ë‹ˆë‹¤.

    âš ï¸ ì£¼ì˜: AddField ì‘ì—…ë“¤ì€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•„ë“œë¡œ ì¸í•œ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì œê±°ë¨.
    í•„ë“œë“¤ì€ ëª¨ë¸ ì •ì˜ì—ì„œ ê´€ë¦¬ë˜ê³ , ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ë§Œ ì´ íŒŒì¼ì—ì„œ ìˆ˜í–‰ë¨.
    """

    dependencies = [
        ("quiz", "0048_add_created_by_to_question"),
    ]

    operations = [
        # âš ï¸ ì£¼ì˜: ëª¨ë“  AddField ì‘ì—…ì´ ì œê±°ë¨
        # ë‹¤êµ­ì–´ í•„ë“œë“¤ì€ ì´ë¯¸ ëª¨ë¸ì— ì •ì˜ë˜ì–´ ìˆìŒ
        # ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

        # 0ë‹¨ê³„: created_language í•„ë“œì˜ ê¸°ë³¸ê°’ ì„¤ì • (í•„ë“œëŠ” ì´ë¯¸ ì¡´ì¬í•¨)
        migrations.RunPython(check_and_set_created_language_defaults, reverse_created_language_defaults),

        # 1ë‹¨ê³„: ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
        migrations.RunPython(safe_migrate_study_data, reverse_migrate),
        migrations.RunPython(safe_migrate_exam_data, reverse_migrate),
        migrations.RunPython(safe_migrate_question_data, reverse_migrate),

        # 2ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ ì—¬ë¶€ ê²€ì¦
        migrations.RunPython(verify_migration_success, reverse_migrate),
    ]
