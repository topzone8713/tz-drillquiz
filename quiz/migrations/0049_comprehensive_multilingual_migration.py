# Generated by Django 4.2.7 on 2025-08-18 22:45
# 
# ğŸš¨ ì¤‘ìš”: ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë³µì‚¬í•©ë‹ˆë‹¤!
# 
# ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ:
# 1. ëª¨ë“  ëª¨ë¸ì— ë‹¤êµ­ì–´ í•„ë“œ ì¶”ê°€
# 2. ê¸°ì¡´ ë°ì´í„°ë¥¼ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë³µì‚¬
# 3. ê¸°ì¡´ í•„ë“œëŠ” ìœ ì§€ (ë‚˜ì¤‘ì— ë³„ë„ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ì œê±°)
#
# ì ìš© ëŒ€ìƒ:
# - Study: title, goal â†’ title_ko, title_en, goal_ko, goal_en
# - Exam: title, description â†’ title_ko, title_en, description_ko, description_en
# - Question: title, content, answer, explanation â†’ title_ko, title_en, content_ko, content_en, answer_ko, answer_en, explanation_ko, explanation_en

from django.db import migrations, models

def migrate_study_data(apps, schema_editor):
    """Study ëª¨ë¸ì˜ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜"""
    Study = apps.get_model('quiz', 'Study')

    from django.db import connection
    
    with connection.cursor() as cursor:
        # ê¸°ì¡´ titleê³¼ goal ê°’ ì¡°íšŒ
        cursor.execute("""
            SELECT id, title, goal 
            FROM quiz_study 
            WHERE title IS NOT NULL OR goal IS NOT NULL
        """)
        
        for row in cursor.fetchall():
            study_id, title, goal = row
            study = Study.objects.get(id=study_id)
            
            # ê¸°ì¡´ titleì„ í•œêµ­ì–´ë¡œ ì„¤ì •
            if title:
                study.title_ko = title
                study.title_en = title  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                study.is_ko_complete = True
                study.is_en_complete = False
            
            # ê¸°ì¡´ goalì„ í•œêµ­ì–´ë¡œ ì„¤ì •
            if goal:
                study.goal_ko = goal
                study.goal_en = ""  # ì˜ì–´ ëª©í‘œëŠ” ë¹ˆ ê°’ìœ¼ë¡œ ìœ ì§€
                study.is_ko_complete = study.is_ko_complete and True
                study.is_en_complete = study.is_en_complete and False
            
            # ìƒì„± ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
            study.created_language = 'ko'
            
            study.save()

def migrate_exam_data(apps, schema_editor):
    """Exam ëª¨ë¸ì˜ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜"""
    Exam = apps.get_model('quiz', 'Exam')

    from django.db import connection
    
    with connection.cursor() as cursor:
        # ê¸°ì¡´ titleê³¼ description ê°’ ì¡°íšŒ
        cursor.execute("""
            SELECT id, title, description 
            FROM quiz_exam 
            WHERE title IS NOT NULL OR description IS NOT NULL
        """)
        
        for row in cursor.fetchall():
            exam_id, title, description = row
            exam = Exam.objects.get(id=exam_id)
            
            # ê¸°ì¡´ titleì„ í•œêµ­ì–´ë¡œ ì„¤ì •
            if title:
                exam.title_ko = title
                exam.title_en = title  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                exam.is_ko_complete = True
                exam.is_en_complete = False
            
            # ê¸°ì¡´ descriptionì„ í•œêµ­ì–´ë¡œ ì„¤ì •
            if description:
                exam.description_ko = description
                exam.description_en = ""  # ì˜ì–´ ì„¤ëª…ì€ ë¹ˆ ê°’ìœ¼ë¡œ ìœ ì§€
                exam.is_ko_complete = exam.is_ko_complete and True
                exam.is_en_complete = exam.is_en_complete and False
            
            # ìƒì„± ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
            exam.created_language = 'ko'
            
            exam.save()

def migrate_question_data(apps, schema_editor):
    """Question ëª¨ë¸ì˜ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë‹¤êµ­ì–´ í•„ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜"""
    Question = apps.get_model('quiz', 'Question')

    from django.db import connection
    
    with connection.cursor() as cursor:
        # ê¸°ì¡´ title, content, answer, explanation ê°’ ì¡°íšŒ
        cursor.execute("""
            SELECT id, title, content, answer, explanation 
            FROM quiz_question 
            WHERE title IS NOT NULL OR content IS NOT NULL OR answer IS NOT NULL OR explanation IS NOT NULL
        """)
        
        for row in cursor.fetchall():
            question_id, title, content, answer, explanation = row
            question = Question.objects.get(id=question_id)
            
            # ê¸°ì¡´ titleì„ í•œêµ­ì–´ë¡œ ì„¤ì •
            if title:
                question.title_ko = title
                question.title_en = title  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                question.is_ko_complete = True
                question.is_en_complete = False
            
            # ê¸°ì¡´ contentë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
            if content:
                question.content_ko = content
                question.content_en = content  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                question.is_ko_complete = question.is_ko_complete and True
                question.is_en_complete = question.is_en_complete and False
            
            # ê¸°ì¡´ answerë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
            if answer:
                question.answer_ko = answer
                question.answer_en = answer  # ì„ì‹œë¡œ ì˜ì–´ í•„ë“œì—ë„ ë™ì¼í•œ ê°’ ì„¤ì •
                question.is_ko_complete = question.is_ko_complete and True
                question.is_en_complete = question.is_en_complete and False
            
            # ê¸°ì¡´ explanationì„ í•œêµ­ì–´ë¡œ ì„¤ì •
            if explanation:
                question.explanation_ko = explanation
                question.explanation_en = ""  # ì˜ì–´ ì„¤ëª…ì€ ë¹ˆ ê°’ìœ¼ë¡œ ìœ ì§€
                question.is_ko_complete = question.is_ko_complete and True
                question.is_en_complete = question.is_en_complete and False
            
            # ìƒì„± ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
            question.created_language = 'ko'
            
            question.save()

def reverse_migrate(apps, schema_editor):
    """ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ëŒë¦¬ê¸° (í•„ìš”ì‹œ)"""
    # ì—­ë°©í–¥ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ë³µì¡í•˜ë¯€ë¡œ í•„ìš”ì‹œ ë³„ë„ êµ¬í˜„
    pass

class Migration(migrations.Migration):

    dependencies = [
        ("quiz", "0048_add_created_by_to_question"),
    ]

    operations = [
        # âš ï¸ ì£¼ì˜: ëª¨ë“  AddField ì‘ì—…ì´ ì œê±°ë¨
        # ë‹¤êµ­ì–´ í•„ë“œë“¤(created_language, goal_en, goal_ko, title_en, title_ko, is_en_complete, is_ko_complete)
        # ì€ ì´ë¯¸ ëª¨ë¸ì— ì •ì˜ë˜ì–´ ìˆê³  ë‹¤ë¥¸ ë§ˆì´ê·¸ë ˆì´ì…˜(0046, 0047, 0050)ì—ì„œ ì²˜ë¦¬ë¨

        # 4ë‹¨ê³„: ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ë§Œ ìˆ˜í–‰
        migrations.RunPython(migrate_study_data, reverse_migrate),
        migrations.RunPython(migrate_exam_data, reverse_migrate),
        migrations.RunPython(migrate_question_data, reverse_migrate),
    ]
