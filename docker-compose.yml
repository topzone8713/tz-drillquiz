version: '3.8'
services:
  db:
    image: postgres:15
    container_name: drillquiz-db
    environment:
      POSTGRES_DB: drillquiz
      POSTGRES_USER: drillquiz
      POSTGRES_PASSWORD: drillquiz
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: drillquiz-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: drillquiz-backend
    ports:
      - "${DJANGO_PORT:-8000}:8000"
    volumes:
      - .:/app
    environment:
      - DJANGO_SETTINGS_MODULE=drillquiz.settings
      - USE_DOCKER=true
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - POSTGRES_DB=${POSTGRES_DB:-drillquiz}
      - POSTGRES_USER=${POSTGRES_USER:-drillquiz}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-drillquiz}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - DEBUG=${DEBUG:-True}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080}
      - CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/1}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL:-redis://redis:6379/0}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND:-redis://redis:6379/2}
    depends_on:
      - db
      - redis

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: drillquiz-celery-worker
    command: celery -A drillquiz worker --loglevel=info
    volumes:
      - .:/app
    environment:
      - DJANGO_SETTINGS_MODULE=drillquiz.settings
      - USE_DOCKER=true
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - POSTGRES_DB=${POSTGRES_DB:-drillquiz}
      - POSTGRES_USER=${POSTGRES_USER:-drillquiz}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-drillquiz}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/1}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL:-redis://redis:6379/0}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND:-redis://redis:6379/2}
    depends_on:
      - db
      - redis
      - backend

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: drillquiz-frontend
    ports:
      - "${FRONTEND_PORT:-8080}:80"
    environment:
      - VUE_APP_API_HOST=${DJANGO_HOST:-localhost}
      - VUE_APP_API_PORT=${DJANGO_PORT:-8000}
      - VUE_APP_API_PROTOCOL=${API_PROTOCOL:-http}
    depends_on:
      - backend

volumes:
  postgres_data:
  redis_data: 